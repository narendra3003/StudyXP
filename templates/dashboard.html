<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Learning Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: "#6366f1",
              secondary: "#8b5cf6",
            },
            borderRadius: {
              none: "0px",
              sm: "4px",
              DEFAULT: "8px",
              md: "12px",
              lg: "16px",
              xl: "20px",
              "2xl": "24px",
              "3xl": "32px",
              full: "9999px",
              button: "8px",
            },
          },
        },
      };
    </script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Pacifico&family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/remixicon@4.5.0/fonts/remixicon.css"
      rel="stylesheet"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/echarts/5.5.0/echarts.min.js"></script>
    <style>
      :where([class^="ri-"])::before {
        content: "\f3c2";
      }
      body {
        font-family: "Inter", sans-serif;
      }
      input[type="number"]::-webkit-inner-spin-button,
      input[type="number"]::-webkit-outer-spin-button {
        -webkit-appearance: none;
        margin: 0;
      }
    </style>
  </head>
  <body class="bg-gray-50">
    <div class="flex h-screen">
      <aside class="w-64 bg-white shadow-lg flex flex-col">
        <div class="flex items-center justify-between p-4">
          <button id="sidebarToggle" class="text-gray-500 hover:text-primary focus:outline-none">
            <i class="ri-menu-line"></i>
          </button>
        </div>
        <nav class="flex-1 px-4">
          <div class="space-y-2">
            <a
              href="/dashboard"
              class="flex items-center px-4 py-3 text-primary bg-gray-100 rounded-lg font-semibold"
            >
              <div class="w-5 h-5 flex items-center justify-center">
                <i class="ri-dashboard-line"></i>
              </div>
              <span class="ml-3">Dashboard</span>
            </a>
            <a
              href="/insights"
              class="flex items-center px-4 py-3 text-gray-600 hover:bg-gray-100 rounded-lg"
            >
              <div class="w-5 h-5 flex items-center justify-center">
                <i class="ri-bar-chart-line"></i>
              </div>
              <span class="ml-3">Insights</span>
            </a>
            <a
              href="/rewards"
              class="flex items-center px-4 py-3 text-gray-600 hover:bg-gray-100 rounded-lg"
            >
              <div class="w-5 h-5 flex items-center justify-center">
                <i class="ri-trophy-line"></i>
              </div>
              <span class="ml-3">Rewards</span>
            </a>
          </div>
        </nav>
        <div class="p-4">
          <a href="/">
          <div class="bg-gray-100 p-4 rounded-lg">
            <div class="flex items-center">
              <div class="w-5 h-5 flex items-center justify-center">
              <i class="ri-logout-box-r-line"></i>
              </div>
                <span class="text-sm font-medium">Sign Out</p>
            </div>
          </div>
        </a>
        </div>
      </aside>

      <main class="flex-1 overflow-y-auto">
        <header class="bg-white shadow-sm">
          <div class="flex items-center justify-between px-8 py-4">
            <a href="/dashboard" class="flex items-center space-x-2">
              <h1 class="font-['Pacifico'] text-2xl text-primary cursor-pointer">StudyXP</h1>
            </a>
            <div class="flex items-center space-x-4">
              <span class="text-sm font-medium">Hi, {{ user[1] }}!</span>
              <a href="/" class="ml-4 px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-primary">Sign Out</a>
            </div>
          </div>
        </header>

        <div
          class="flex items-center justify-between mb-4"
          style="margin-left: 20px; margin-top: 20px; font-size: 30px"
        >
          <h1
            class="text-lg font-semibold"
            style="font-size: 30px; font-weight: 1000; color: rgb(0, 140, 255)"
          >
           {{username}}
          </h1>
        </div>

        <!-- <div class="Hello name">
            <div class="Hello" style="color: brown;">
                <span> Hello </span>
            </div>
            <span>Sahil</span>
        </div> -->

        <div class="p-8">
          <div class="grid grid-cols-3 gap-6 mb-8">
            <div class="bg-white p-6 rounded-lg shadow-sm">
              <div class="flex items-center justify-between mb-4">
                  <h3 class="text-lg font-semibold">Today's Progress</h3>
                  <span class="text-sm text-gray-500">{{ current_date }}</span>
              </div>
              <div class="flex items-end space-x-2">
                  <div class="text-3xl font-bold">{{ total_hours }}</div>
                  <div class="text-lg text-gray-500 mb-1">hours</div>
              </div>
              <div class="mt-4">
                  <div class="h-2 bg-gray-200 rounded-full overflow-hidden">
                      <div class="h-full bg-primary" style=`width: {{goal_percentage | int}} %` title="{{ goal_percentage }}% of daily goal completed" aria-label="{{ goal_percentage }}% of daily goal completed"></div>
                  </div>
                  <div class="mt-2 text-sm text-gray-500">
                      {{ goal_percentage }}% of daily goal completed
                  </div>
              </div>
          </div>
          

          <div class="bg-white p-6 rounded-lg shadow-sm">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold">Current Streak</h3>
                <div class="w-8 h-8 flex items-center justify-center text-primary">
                    <i class="ri-fire-line ri-xl" aria-label="Streak"></i>
                </div>
            </div>
            <div class="flex items-end space-x-2">
                <div class="text-3xl font-bold" title="Current streak: {{ current_streak }} days" aria-label="Current streak: {{ current_streak }} days">{{ current_streak }}</div>
                <div class="text-lg text-gray-500 mb-1">days</div>
            </div>
            <div class="mt-4 flex space-x-2">
                {% for i in range(current_streak) %}
                    <div class="flex-1 h-1 bg-primary rounded-full"></div>
                {% endfor %}
                {% for i in range(5 - current_streak) %}
                    <div class="flex-1 h-1 bg-gray-200 rounded-full"></div>
                {% endfor %}
            </div>
            <div class="mt-2 text-sm text-gray-500">
                {{ days_to_milestone }} days until next milestone
            </div>
        </div>
        

            <div class="bg-white p-6 rounded-lg shadow-sm">
              <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold">XP Progress</h3>
                <div
                  class="w-8 h-8 flex items-center justify-center text-yellow-500"
                >
                  <i class="ri-medal-line ri-xl"></i>
                </div>
              </div>
              <div class="flex items-end space-x-2">
                <div class="text-3xl font-bold" title="Total XP earned" aria-label="Total XP earned">{{total_xp }}</div>
                <div class="text-lg text-gray-500 mb-1">XP</div>
              </div>
              <div class="mt-4">
                <div class="h-2 bg-gray-200 rounded-full overflow-hidden">
                  <div class="h-full bg-yellow-500" style="width: 80%"></div>
                </div>
                <div class="mt-2 text-sm text-gray-500">550 XP</div>
              </div>
            </div>
          </div>


<!-- Floating Button -->
<button onclick="toggleStudyLogModal()"
  class="fixed bottom-8 right-8 w-14 h-14 bg-primary text-white rounded-full shadow-lg flex items-center justify-center hover:bg-primary/90">
  <i class="ri-add-line ri-xl"></i>
</button>

<!-- Study Time & Subject Distribution Charts -->
<div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
  <!-- Study Time Distribution Chart -->
  <div class="bg-white p-6 rounded-lg shadow-sm">
    <div class="flex items-center justify-between mb-6">
      <h3 class="text-lg font-semibold">Study Time Distribution</h3>
      <div class="flex space-x-2">
        <button id="monthBtn"
          class="px-3 py-1 text-sm text-white bg-primary rounded-full hover:bg-primary/90">Week</button>
      </div>
    </div>
    <div id="studyTimeChart" class="w-full h-64"></div>
  </div>

  <!-- Subject Distribution Chart -->
  <div class="bg-white p-6 rounded-lg shadow-sm">
    <div class="flex items-center justify-between mb-6">
      <h3 class="text-lg font-semibold">Subject Distribution</h3>
      <div class="w-8 h-8 flex items-center justify-center text-gray-400">
        <i class="ri-pie-chart-line ri-xl"></i>
      </div>
    </div>
    <div id="subjectChart" class="w-full h-64"></div>
  </div>
</div>

<!-- Embed JSON Data in Hidden Script Tags -->
<script type="application/json" id="studyTimeData">
  {{ study_time_data | tojson | safe }}
</script>
<script type="application/json" id="subjectData">
  {{ subject_distribution | tojson | safe }}
</script>

<div class="mt-8 bg-white p-6 rounded-lg shadow-sm">
  <div class="flex items-center justify-between mb-6">
      <h3 class="text-lg font-semibold">Notifications</h3>
      <button class="text-primary hover:text-primary-dark">View All</button>
  </div>
  <div class="space-y-4">
      {% for notification in notifications %}
      <div class="flex items-center justify-between py-3 border-b">
          <div class="flex items-center space-x-4">
              <div class="w-10 h-10 flex items-center justify-center bg-blue-100 rounded-lg text-blue-500">
                  <i class="ri-{{ notification.type }}-line ri-lg"></i>
              </div>
              <div>
                  <p class="font-medium">{{ notification.message }}</p>
                  <p class="text-sm text-gray-500">{{ notification.time_ago }}</p>
              </div>
          </div>
          <span class="text-sm font-medium text-blue-500">{{ notification.extra_info }}</span>
      </div>
      {% endfor %}
  </div>
</div>


    <!-- Study Log Page -->
<div id="studyLogModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center">
  <div class="bg-white rounded-lg w-[480px] p-6">
    <div class="flex justify-between items-center mb-6">
      <h3 class="text-xl font-semibold">Add Study Session</h3>
      <button onclick="toggleStudyLogModal()" class="text-gray-400 hover:text-gray-600">
        <i class="ri-close-line ri-lg"></i>
      </button>
    </div>
    <form id="studyLogForm" class="space-y-4">
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Choose Subject</label>
        <div class="relative">
          <select id="subjectSelect" class="w-full pl-3 pr-10 py-2 text-sm border rounded-lg appearance-none focus:outline-none focus:ring-2 focus:ring-primary">
            {% for subject in subjects %}
              <option value="{{ subject[1] }}">{{ subject[1] }}</option>
            {% endfor %}
          </select>
          <div class="absolute inset-y-0 right-0 flex items-center px-2 pointer-events-none">
            <i class="ri-arrow-down-s-line text-gray-400"></i>
          </div>
        </div>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Minutes Studied</label>
        <input type="number" id="studyDuration" min="0.5" max="720" step="0.5" class="w-full px-3 py-2 text-sm border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" placeholder="Enter minutes" />
      </div>
      <div class="flex justify-end space-x-3 mt-6">
        <button type="button" onclick="toggleStudyLogModal()" class="px-4 py-2 text-sm text-gray-600 hover:text-gray-800 border rounded-button focus:outline-none focus:ring-2 focus:ring-primary">Cancel</button>
        <button type="submit" class="px-4 py-2 text-sm text-white bg-primary hover:bg-primary/90 rounded-button focus:outline-none focus:ring-2 focus:ring-primary">Add Session</button>
      </div>
    </form>
  </div>
</div>
<button onclick="toggleStudyLogModal()" class="fixed bottom-8 right-8 w-14 h-14 bg-primary text-white rounded-full shadow-lg flex items-center justify-center hover:bg-primary/90">
  <i class="ri-add-line ri-xl"></i>
</button>

<script>
  function toggleStudyLogModal() {
    const modal = document.getElementById("studyLogModal");
    modal.classList.toggle("hidden");
    modal.classList.toggle("flex");
  }

  document.getElementById("studyLogForm").addEventListener("submit", async function (e) {
    e.preventDefault();
    const subject = document.getElementById("subjectSelect").value;
    const duration = document.getElementById("studyDuration").value;

    const response = await fetch("/log_study_session", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({ subject, duration }),
    });

    const result = await response.json();
    if (result.success) {
      // Show success message
      const successToast = document.createElement("div");
      successToast.className = "fixed bottom-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg";
      successToast.textContent = "Study session logged successfully!";
      document.body.appendChild(successToast);
      setTimeout(() => successToast.remove(), 3000);

      toggleStudyLogModal();
      this.reset();
    } else {
      alert("Failed to log study session. Try again.");
    }
  });
</script>
<script>
  async function fetchStudyData() {
    try {
      const response = await fetch("http://127.0.0.1:5000/study_insights");
      const result = await response.json();
      if (!result.success) throw new Error(result.message);
      return result.data;
    } catch (error) {
      console.error("Error fetching study data:", error);
      return {};
    }
  }

  // Use subjects from Jinja context
  const subjects = [
    {% for subject in subjects %}
      { id: {{ subject[0] }}, name: "{{ subject[1] }}", goal: {{ subject[2] }} },
    {% endfor %}
  ];

  // Dynamically build chart series and legends
  function buildChartData(studyData, labels) {
    // Optionally assign color in the object below if you want
    return subjects.map(subj => ({
      name: subj.name,
      data: labels.map(date => (Number(studyData[date]?.[subj.name]) || 0) / 60),
      type: "bar",
      stack: "study",
      barWidth: "50%",
    }));
  }

  async function renderCharts() {
    const studyData = await fetchStudyData();
    const labels = Object.keys(studyData).sort();
    let subjectTotals = {};
    let totalStudyHours = [];
    labels.forEach(date => {
      let dailyTotal = 0;
      Object.entries(studyData[date]).forEach(([subject, hours]) => {
        const studyHours = parseFloat(hours) || 0;
        subjectTotals[subject] = (subjectTotals[subject] || 0) + studyHours;
        dailyTotal += studyHours;
      });
      totalStudyHours.push(dailyTotal);
    });
    // Prepare pie chart data (subject-wise distribution)
    const subjectData = Object.entries(subjectTotals).map(([subject, value]) => ({
      value: value / 60,
      name: subject
    }));
    // Build dynamic series
    const series = buildChartData(studyData, labels);
    // Initializing chart
    const studyTimeChart = echarts.init(document.getElementById("studyTimeChart"));
    studyTimeChart.setOption({
      animation: false,
      grid: {
        top: 10,
        right: 10,
        bottom: 40,
        left: 50,
        containLabel: true,
      },
      xAxis: {
        type: "category",
        data: labels,
        axisLine: { lineStyle: { color: "#e5e7eb" } },
        axisLabel: { color: "#1f2937", rotate: 25 },
        name: "Date",
        nameLocation: "middle",
        nameGap: 30
      },
      yAxis: {
        type: "value",
        axisLine: { lineStyle: { color: "#e5e7eb" } },
        axisLabel: { color: "#1f2937" },
        splitLine: { lineStyle: { color: "#f3f4f6" } },
        name: "Hours Studied",
        nameLocation: "middle",
        nameGap: 40
      },
      series: series,
      tooltip: {
        trigger: "axis",
        axisPointer: { type: "shadow" },
        formatter: function(params) {
          let out = `<b>${params[0].axisValue}</b><br/>`;
          params.forEach(p => {
            out += `<span style='color:${p.color}'>●</span> <b>${p.seriesName}</b>: ${p.data.toFixed(2)} hours<br/>`;
          });
          const total = params.reduce((sum, p) => sum + (p.data || 0), 0);
          out += `<b>Total:</b> ${total.toFixed(2)} hours`;
          return out;
        }
      },
      legend: {
        data: subjects.map(s => s.name),
        textStyle: { color: "#1f2937" },
        top: 0
      },
    });


    // Subject Distribution Pie Chart
    const subjectChart = echarts.init(document.getElementById("subjectChart"));
    subjectChart.setOption({
      animation: false,
      tooltip: {
        trigger: "item",
        backgroundColor: "rgba(255, 255, 255, 0.9)",
        textStyle: { color: "#1f2937" },
        formatter: function(params) {
          const hours = params.value.toFixed(2);
          const percent = params.percent;
          return `<b>${params.name}</b><br/>${hours} hours (${percent}%)`;
        }
      },
      series: [
        {
          type: "pie",
          radius: ["40%", "70%"],
          itemStyle: {
            borderRadius: 6,
            borderColor: "#fff",
            borderWidth: 2,
          },
          label: {
            show: true,
            position: "outside",
            formatter: function(params) {
              return `${params.name}: ${params.percent}%\n(${params.value.toFixed(2)}h)`;
            },
            color: "#1f2937",
          },
          data: subjectData,
          color: ["#57b5e7", "#8dd3c7", "#fbbf72", "#fc8d62", "#b3de69"],
        },
      ],
      legend: {
        orient: 'vertical',
        left: 'left',
        textStyle: { color: '#1f2937' },
        formatter: function(name) {
          const d = subjectData.find(s => s.name === name);
          return `${name} (${d ? d.value.toFixed(2) : 0}h)`;
        }
      }
    });

    window.addEventListener("resize", () => {
      studyTimeChart.resize();
      subjectChart.resize();
    });
  }

  renderCharts();
</script>

<script>
  const sidebar = document.querySelector('aside');
  const toggleBtn = document.getElementById('sidebarToggle');
  toggleBtn.addEventListener('click', () => {
    sidebar.classList.toggle('w-64');
    sidebar.classList.toggle('w-20');
    sidebar.querySelectorAll('span').forEach(span => span.classList.toggle('hidden'));
    sidebar.querySelectorAll('.sidebar-action span').forEach(span => span.classList.toggle('hidden'));
  });
</script>

  </body>
</html>
